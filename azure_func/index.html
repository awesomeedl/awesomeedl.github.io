<!doctype html><html><head><title>Learning Journey: Azure Functions</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content="Tying together Azure Functions, .Net Core Web API, and Entity Framework"><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><script src=/js/toc.js></script>
<link type=text/css rel=stylesheet href=/vendor/css/bootstrap.min.css><link rel=stylesheet href=/scss/journal.min.7c01e9f6fb2f6083d79d2f3a32ec6b7901e262e94a52a64a542aef98bc5bda64.css integrity="sha256-fAHp9vsvYIPXnS86MuxreQHiYulKUqZKVCrvmLxb2mQ=" media=screen><link rel=stylesheet href=/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media=screen><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Material+Icons"></head><body><div id=app><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item false" href=/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/about>About</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#background class=nav-background>Background</a></li><li><a href=#the-goals class=nav-the-goals>The Goals</a></li><li><a href=#the-tools class=nav-the-tools>The Tools</a></li><ul><li><a href=#cloud-provider---azure class=nav-cloud-provider---azure>Cloud Provider - Azure</a></li><li><a href=#database---azure-sql class=nav-database---azure-sql>Database - Azure SQL</a></li><li><a href=#net-core-web-api-or-is-there-another-option class=nav-net-core-web-api-or-is-there-another-option>.NET Core Web API, or is there another option?</a></li><li><a href=#azure-functions class=nav-azure-functions>Azure Functions</a></li></ul><li><a href=#the-confusion-begins class=nav-the-confusion-begins>The Confusion Begins…</a></li><ul><li><a href=#what-is-csx class=nav-what-is-csx>“What is .csx?”</a></li><li><a href=#what-is-an-sql-binding class=nav-what-is-an-sql-binding>“What is an SQL binding??”</a></li></ul><li><a href=#going-back-to-the-old-recipe class=nav-going-back-to-the-old-recipe>Going back to the old recipe</a></li><ul><li><a href=#getting-entity-framework-core-to-work-with-azure-functions class=nav-getting-entity-framework-core-to-work-with-azure-functions>“Getting Entity Framework Core to work with Azure Functions”</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=http://awesomeedl.github.io/>Edward Liao</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=http://awesomeedl.github.io/><div class=single-column-header-title>Edward Liao</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper style=background-image:url(http://awesomeedl.github.io/af.svg)><div class=post-title>Learning Journey: Azure Functions<div class=post-subtitle>Tying together Azure Functions, .Net Core Web API, and Entity Framework</div><div class=post-meta><time itemprop=datePublished>2023-02-13 10:50</time>
<i class=material-icons>label</i>
<a href=/tags/azure>Azure</a>
&nbsp;
<a href=/tags/web-development>Web Development</a>
&nbsp;
<a href=/tags/serverless-computing>Serverless Computing</a>
&nbsp;
<a href=/tags/database>Database</a>
&nbsp;
<a href=/tags/.net-framework>.Net Framework</a>
&nbsp;</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h1 id=background>Background</h1><p>After dipping my toes into the water of using .NET to write RESTful APIs, soon enough I find myself amazed by the number of tools, platforms, and options available in the .NET ecosystem. Recently I had the idea of writing a monthly expense tracking app, which I thought would be the perfect opportunity to experiment with different things in .Net and Azure that I haven&rsquo;t touched before.</p><h1 id=the-goals>The Goals</h1><p>My main goal is to have a basic CRUD API available for my front end to add, retrieve, and update transactions. I would also like all of my stuff to be on the cloud as I didn&rsquo;t feel like wrestling with hosting stuff myself. With that in mind, I have a couple of decisions to make:</p><h1 id=the-tools>The Tools</h1><h2 id=cloud-provider---azure>Cloud Provider - Azure</h2><p>As the title suggests, I went with Azure. I probably could have gone with a cheaper option but I thought learning it might be a nice addition to my skill set. It&rsquo;s also convenient that since I would be working with .Net stuff, they would integrate nicely.</p><h2 id=database---azure-sql>Database - Azure SQL</h2><p>Since I have worked with Azure SQL before, I might as well stick with it. It&rsquo;s easy to set up and once I did I can forget about it. Initially, I also had the itch to try out a document database like CosmosDB and MongoDB but I soon decided it was a rabbit hole destined for another project.</p><h2 id=net-core-web-api-or-is-there-another-option>.NET Core Web API, or is there another option?</h2><p>My last CRUD app was written as a .Net web API, hosted on Azure as a Web App Service. It was easy to deploy and suited my need, with only one problem &ndash; <strong>Cost</strong>. Azure Web App Service incurs charges as long as it is running, no matter how few requests it receives. Since this is a hobby project I probably will only have a single digit amount of requests each day, I did not like the fact that I would be paying for all the time the web app is running idle.</p><h2 id=azure-functions>Azure Functions</h2><p>I then learned that I can write my API as Azure Functions, a serverless SaaS solution that&rsquo;s very similar to a .Net Core web app, with the added benefit of being more modular as every endpoint is represented by its own function. The best part is, it will charge me <strong>per request</strong>! Definitely sounds like the perfect candidate for my needs! (And I will also have another thing to brag about on my resume)</p><h1 id=the-confusion-begins>The Confusion Begins&mldr;</h1><h2 id=what-is-csx>&ldquo;What is .csx?&rdquo;</h2><p>After some setting up, it seems that AF can be written as a traditional <code>.cs</code> file, which I need to use an IDE for. Or, I could write it as a C# script <code>.csx</code> file, which could be edited directly on the Azure Portal, how cool is that! (spoiler: it&rsquo;s not).</p><h2 id=what-is-an-sql-binding>&ldquo;What is an SQL binding??&rdquo;</h2><p>Since I am writing a CRUD API, obviously I need some way to query the database within my web app. In the previous .Net Core project, I used Entity Framework Core, so <em>&ldquo;maybe I could use that here?&rdquo;</em> &ndash; the naive me thought. A quick Google search yielded &ndash; nothing. Welp, time to look for another solution! I then came across <a href="https://learn.microsoft.com/en-us/azure/azure-functions/functions-bindings-azure-sql?tabs=in-process%2Cextensionv4&pivots=programming-language-csharp">this official doc page</a> that seems to be what I need &ndash; I just need to write an HTTP trigger function with SQL input binding for each get endpoint, and SQL output binding for each post endpoint, which seems easy enough. (spoiler: it&rsquo;s not)</p><h1 id=going-back-to-the-old-recipe>Going back to the old recipe</h1><p>After digging through the non-existent documentation and Stackoverflow posts on what I was trying to do, I finally gave up on writing the <code>.csx</code> files and went back to writing <code>.cs</code> with VS Code. Suddenly, all the documentation started making sense and I had finally made a working endpoint that retrieves all the records in my database table.</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8fbcbb>[FunctionName(&#34;GetAllTransactions&#34;)]</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>public</span> <span style=color:#81a1c1;font-weight:700>static</span> IActionResult Run<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span><span style=color:#8fbcbb>    [HttpTrigger(AuthorizationLevel.Anonymous, &#34;get&#34;, Route = null)]</span>
</span></span><span style=display:flex><span>    HttpRequest req<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span><span style=color:#8fbcbb>    [Sql(&#34;select * from dbo.Transactions&#34;,
</span></span></span><span style=display:flex><span><span style=color:#8fbcbb>        CommandType = System.Data.CommandType.Text,
</span></span></span><span style=display:flex><span><span style=color:#8fbcbb>        ConnectionStringSetting = &#34;SqlConnectionString&#34;)]</span>
</span></span><span style=display:flex><span>    IEnumerable<span style=color:#eceff4>&lt;</span>Transaction<span style=color:#eceff4>&gt;</span> transactions<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>new</span> OkObjectResult<span style=color:#eceff4>(</span>transactions<span style=color:#eceff4>);</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span></code></pre></div><p>Apparently, I overlooked the fact that the documentation was intended for regular old <code>.cs</code> functions and not <code>.csx</code> functions. Things finally started making sense.</p><p>HTTP Trigger + SQL Binding worked pretty nicely so far until I decided to allow query parameters on my endpoints, which looked something like this:<br><code>http://myapiurl/gettransaction?month=2&type=food</code><br>I soon realized the problem &ndash; The SQL statement <code>[Sql("some SQL query")]</code>was predetermined, and there was no way I could generate statements based on parameters in the request&rsquo;s query string! It seems that going back to Entity Framework Core was inevitable&mldr;</p><h2 id=getting-entity-framework-core-to-work-with-azure-functions>&ldquo;Getting Entity Framework Core to work with Azure Functions&rdquo;</h2><p>Setting up EF Core in a .Net Core project was not easy, but at least doable thanks to the documentation available online. It was, however, not a good experience trying to add EF Core into my Azure Functions. After many hours of digging through documentation and pulling my hair out, I <strong>FINALLY</strong> got it to work.</p><p>The first step is to install the packages required for EF Core, which I did by adding the following two lines to the <code>.csproj</code> file.</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#81a1c1>&lt;PackageReference</span> <span style=color:#8fbcbb>Include=</span><span style=color:#a3be8c>&#34;Microsoft.EntityFrameworkCore&#34;</span> <span style=color:#8fbcbb>Version=</span><span style=color:#a3be8c>&#34;6.*&#34;</span> <span style=color:#81a1c1>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#81a1c1>&lt;PackageReference</span> <span style=color:#8fbcbb>Include=</span><span style=color:#a3be8c>&#34;Microsoft.EntityFrameworkCore.SqlServer&#34;</span> <span style=color:#8fbcbb>Version=</span><span style=color:#a3be8c>&#34;6.*&#34;</span> <span style=color:#81a1c1>/&gt;</span>
</span></span></code></pre></div><p>Note that I had to tell the app to specifically use the <code>6.x</code> version, which is the latest .Net version that Azure Function supports. If I leave the version blank it will use the <code>7.x</code> versions which will cause the build to fail.</p><p>I then need to create a <code>Startup.cs</code> file to configure the builder services like this:</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8fbcbb>[assembly: FunctionsStartup(typeof(MoneyTrackAPI.Startup))]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>namespace</span> <span style=color:#8fbcbb>MoneyTrackAPI</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>public</span> <span style=color:#81a1c1;font-weight:700>class</span> <span style=color:#8fbcbb>Startup</span> <span style=color:#eceff4>:</span> FunctionsStartup
</span></span><span style=display:flex><span>    <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>public</span> <span style=color:#81a1c1;font-weight:700>override</span> <span style=color:#81a1c1;font-weight:700>void</span> Configure<span style=color:#eceff4>(</span>IFunctionsHostBuilder builder<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            builder<span style=color:#eceff4>.</span>Services<span style=color:#eceff4>.</span>AddDbContext<span style=color:#eceff4>&lt;</span>DbContext<span style=color:#eceff4>&gt;(</span>
</span></span><span style=display:flex><span>              options <span style=color:#eceff4>=&gt;</span> SqlServerDbContextOptionsExtensions<span style=color:#eceff4>.</span>UseSqlServer<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>                options<span style=color:#eceff4>,</span> Environment<span style=color:#eceff4>.</span>GetEnvironmentVariable<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>                    <span style=color:#a3be8c>&#34;SQLAZURECONNSTR_ConnectionString&#34;</span><span style=color:#eceff4>)));</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span></code></pre></div><p>Now, I can finally do the usual <code>dotnet ef dbcontext scaffold</code> command to generate the <code>DbContext.cs</code> and <code>Transaction.cs</code> file which allows me to query the database using LINQ, which means I can successfully call the get endpoint with query parameters. The actual function looks like this:</p><div class=highlight><pre tabindex=0 style=color:#d8dee9;background-color:#2e3440;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#81a1c1;font-weight:700>public</span> <span style=color:#81a1c1;font-weight:700>class</span> <span style=color:#8fbcbb>GetTransactions</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>private</span> <span style=color:#81a1c1;font-weight:700>readonly</span> DbContext _dbContext<span style=color:#eceff4>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>public</span> GetTransactions<span style=color:#eceff4>(</span>DbContext dbContext<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        _dbContext <span style=color:#eceff4>=</span> dbContext<span style=color:#eceff4>;</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#8fbcbb>
</span></span></span><span style=display:flex><span><span style=color:#8fbcbb>    [FunctionName(&#34;GetTransactions&#34;)]</span>
</span></span><span style=display:flex><span>    <span style=color:#81a1c1;font-weight:700>public</span> <span style=color:#81a1c1;font-weight:700>async</span> Task<span style=color:#eceff4>&lt;</span>IActionResult<span style=color:#eceff4>&gt;</span> Run<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span><span style=color:#8fbcbb>        [HttpTrigger(AuthorizationLevel.Anonymous, &#34;get&#34;, Route = &#34;transaction&#34;)]</span> 
</span></span><span style=display:flex><span>        HttpRequest req<span style=color:#eceff4>,</span>
</span></span><span style=display:flex><span>        ILogger log<span style=color:#eceff4>)</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>var</span> query <span style=color:#eceff4>=</span> req<span style=color:#eceff4>.</span>Query<span style=color:#eceff4>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1>var</span> transactions <span style=color:#eceff4>=</span> _dbContext<span style=color:#eceff4>.</span>Transactions<span style=color:#eceff4>.</span>AsNoTracking<span style=color:#eceff4>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>try</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>if</span> <span style=color:#eceff4>(</span>query<span style=color:#eceff4>.</span>ContainsKey<span style=color:#eceff4>(</span><span style=color:#a3be8c>&#34;month&#34;</span><span style=color:#eceff4>))</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>                transactions <span style=color:#eceff4>=</span> transactions<span style=color:#eceff4>.</span>Where<span style=color:#eceff4>(</span>
</span></span><span style=display:flex><span>                    t <span style=color:#eceff4>=&gt;</span> t<span style=color:#eceff4>.</span>TransactionDate<span style=color:#eceff4>.</span>Month <span style=color:#eceff4>==</span> <span style=color:#81a1c1>int</span><span style=color:#eceff4>.</span>Parse<span style=color:#eceff4>(</span>query<span style=color:#eceff4>[</span><span style=color:#a3be8c>&#34;month&#34;</span><span style=color:#eceff4>]));</span>
</span></span><span style=display:flex><span>            <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>catch</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>{</span>
</span></span><span style=display:flex><span>            <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>new</span> BadRequestResult<span style=color:#eceff4>();</span>
</span></span><span style=display:flex><span>        <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#81a1c1;font-weight:700>return</span> <span style=color:#81a1c1;font-weight:700>new</span> OkObjectResult<span style=color:#eceff4>(</span><span style=color:#81a1c1;font-weight:700>await</span> transactions<span style=color:#eceff4>.</span>ToListAsync<span style=color:#eceff4>());</span>
</span></span><span style=display:flex><span>    <span style=color:#eceff4>}</span>
</span></span><span style=display:flex><span><span style=color:#eceff4>}</span>
</span></span></code></pre></div><p>Voila! After jumping through so many hoops I finally have a GET endpoint that functions like how I wanted. Notice when I want to match more parameters in the query string I can simply add another <code>if (query.ContainsKey()) {}</code> block, and EF Core will generate the SQL query behind the scene. What&rsquo;s left for me to do is adding the POST and UPDATE endpoints, which should be trivial.</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2023-02-13</p></div></div><nav class=post-pagination><a class=newer-posts>Next<br>No newer posts.</a>
<a class=older-posts href=/about/>Previous<br>About Me</a></nav><div class=post-comment-wrapper></div></div></div></div></div><div id=sideContainer class=side-container><a class="a-block nav-head false" href=http://awesomeedl.github.io/><div class=nav-title>Edward Liao</div></a><div class=nav-link-list><a class="a-block nav-link-item false" href=/tags>Tags</a>
<a class="a-block nav-link-item false" href=/about>About</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
2023 Edward Liao</div></div><div id=extraContainer class=extra-container><div class=toc-wrapper><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><li><a href=#background class=nav-background>Background</a></li><li><a href=#the-goals class=nav-the-goals>The Goals</a></li><li><a href=#the-tools class=nav-the-tools>The Tools</a></li><ul><li><a href=#cloud-provider---azure class=nav-cloud-provider---azure>Cloud Provider - Azure</a></li><li><a href=#database---azure-sql class=nav-database---azure-sql>Database - Azure SQL</a></li><li><a href=#net-core-web-api-or-is-there-another-option class=nav-net-core-web-api-or-is-there-another-option>.NET Core Web API, or is there another option?</a></li><li><a href=#azure-functions class=nav-azure-functions>Azure Functions</a></li></ul><li><a href=#the-confusion-begins class=nav-the-confusion-begins>The Confusion Begins…</a></li><ul><li><a href=#what-is-csx class=nav-what-is-csx>“What is .csx?”</a></li><li><a href=#what-is-an-sql-binding class=nav-what-is-an-sql-binding>“What is an SQL binding??”</a></li></ul><li><a href=#going-back-to-the-old-recipe class=nav-going-back-to-the-old-recipe>Going back to the old recipe</a></li><ul><li><a href=#getting-entity-framework-core-to-work-with-azure-functions class=nav-getting-entity-framework-core-to-work-with-azure-functions>“Getting Entity Framework Core to work with Azure Functions”</a></li></ul></div></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
2023 Edward Liao</div></div><script src=/js/journal.js></script></body></html>